<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial 1: Data Preparation • mTopic</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial 1: Data Preparation">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mTopic</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Get Started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tutorial-1-data-preparation.html">Data Preparation</a>
    </li>
    <li>
      <a href="../articles/tutorial-2-P22-mouse-brain.html">P22 Mouse Brain (ATAC + RNA)</a>
    </li>
    <li>
      <a href="../articles/tutorial-3-human-tonsil.html">Human Tonsil (RNA + Protein Epitopes)</a>
    </li>
    <li>
      <a href="../articles/tutorial-4-human-pbmc.html">Human PBMC (ATAC + RNA + Protein Epitopes)</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">API</a>
</li>
<li>
  <a href="https://github.com/TabakaLab/mTopic" class="external-link">Python Package</a>
</li>
<li>
  <a href="https://github.com/TabakaLab/mTopic/tree/main/dashboard" class="external-link">Interactive Dashboard</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/TabakaLab/mTopicR/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Tutorial 1: Data Preparation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/TabakaLab/mTopicR/blob/HEAD/vignettes/tutorial-1-data-preparation.Rmd" class="external-link"><code>vignettes/tutorial-1-data-preparation.Rmd</code></a></small>
      <div class="hidden name"><code>tutorial-1-data-preparation.Rmd</code></div>

    </div>

    
    
<p>Welcome to this tutorial on using the <code>mTopic</code> R package
to prepare data for multimodal topic modeling of single-cell data. The
<code>mTopic</code> package enables you to perform both spatial and
non-spatial multimodal topic modeling, allowing you to uncover complex
patterns across multiple modalities, such as ATAC, RNA, and protein, in
single-cell experiments.</p>
<p>Data preprocessing is a critical first step in any single-cell
analysis pipeline. Proper preprocessing ensures that the data is clean,
well-structured, and ready for modeling. It helps remove noise,
normalize counts, and standardize features across modalities, ensuring
the results are biologically meaningful and statistically robust. In
this tutorial, we will demonstrate how to preprocess a multimodal
dataset to prepare it for topic modeling using <code>mTopic</code>. We
will:</p>
<ul>
<li>Load Seurat data stored in the rds format.</li>
<li>Perform quality control to filter low-quality cells and
features.</li>
<li>Normalize and scale the data for cross-modality comparability.</li>
<li>Extract relevant features.</li>
</ul>
<p>We use a publicly available dataset from GEO (<a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE218593" class="external-link">GSE218593</a>
and <a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE205055" class="external-link">GSE205055</a>),
which includes ATAC and RNA measurements from P22 mouse brain. A
preprocessed .rds file version of this dataset is available at <a href="https://zenodo.org/records/15472980" class="external-link">Zenodo</a>.</p>
<p>Before we begin, let’s import all the necessary libraries and set the
working directory.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/TabakaLab/mTopicR" class="external-link">mTopic</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset_name</span> <span class="op">&lt;-</span> <span class="st">"P22_Mouse_Brain_ATAC_RNA_raw.rds"</span></span>
<span><span class="va">working_dir</span> <span class="op">&lt;-</span> <span class="st">'~/projects/datasets/'</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">working_dir</span>, <span class="va">dataset_name</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"https://zenodo.org/records/15472980/files/"</span>, <span class="va">dataset_name</span>, <span class="st">"?download=1"</span><span class="op">)</span>, </span>
<span>    destfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">working_dir</span>, <span class="va">dataset_name</span><span class="op">)</span>, </span>
<span>    mode <span class="op">=</span> <span class="st">"wb"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code>mTopic</code> R package is designed to work with Seurat
objects, which are specialized data structures for handling multimodal
single-cell data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p22</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">working_dir</span>, <span class="va">dataset_name</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The loaded Seurat object <code>p22</code>, which contains raw ATAC
and RNA data from P22 mouse brain.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p22</span></span>
<span><span class="co">#&gt; An object of class Seurat </span></span>
<span><span class="co">#&gt; 92955 features across 9215 samples within 2 assays </span></span>
<span><span class="co">#&gt; Active assay: atac (70152 features, 0 variable features)</span></span>
<span><span class="co">#&gt;  1 layer present: counts</span></span>
<span><span class="co">#&gt;  1 other assay present: rna</span></span>
<span><span class="co">#&gt;  1 dimensional reduction calculated: Spatial</span></span></code></pre></div>
<p>The wrapper relies on a Seurat v5 object. Please ensure that the
assays in your dataset are of class <code>Assay5</code>. If they are of
class <code>Assay</code>, use the <code>update_assays</code> function
before proceeding with the analysis.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">p22</span><span class="op">@</span><span class="va">assays</span>, <span class="kw">function</span><span class="op">(</span><span class="va">assay</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">assay</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; $atac</span></span>
<span><span class="co">#&gt; [1] "Assay5"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $rna</span></span>
<span><span class="co">#&gt; [1] "Assay5"</span></span>
<span><span class="co">#object &lt;- update_assays(object)</span></span></code></pre></div>
<p>Before running topic modeling, the data must be preprocessed to
ensure it is clean, informative, and suitable for analysis. The
filtering pipeline includes the following steps:</p>
<ul>
<li>
<strong>Permutation of counts (<code>permute</code>).</strong>
Randomizes cell counts within each feature to estimate technical noise
and identify overrepresented features.</li>
<li>
<strong>Transformation of count matrices.</strong> A <strong>TF-IDF
transformation (<code>tfidf</code>)</strong>, used for ATAC/histone
modification/RNA data adjusts raw feature counts by balancing their
frequency and importance, making rare but biologically relevant features
more prominent. A <strong>CLR normalization (<code>clr</code>)</strong>,
used for protein data, normalizes the count matrices by addressing
compositional biases, ensuring that protein-level data is standardized
across cells.</li>
<li>
<strong>Scaling counts (<code>scale_counts</code>).</strong> Scales
total counts across modalities to ensure equal contribution during
modeling.</li>
</ul>
<p>Permutation-based preprocessing helps highlight overrepresented
features, reducing the risk of technical artifacts influencing
results.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p22</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tfidf.html">tfidf</a></span><span class="op">(</span><span class="va">p22</span>, mod <span class="op">=</span> <span class="st">'rna'</span><span class="op">)</span></span>
<span><span class="va">p22</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tfidf.html">tfidf</a></span><span class="op">(</span><span class="va">p22</span>, mod <span class="op">=</span> <span class="st">'atac'</span><span class="op">)</span></span>
<span><span class="va">p22</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scale_counts.html">scale_counts</a></span><span class="op">(</span><span class="va">p22</span><span class="op">)</span></span>
<span><span class="va">p22</span></span>
<span><span class="co">#&gt; An object of class Seurat </span></span>
<span><span class="co">#&gt; 92955 features across 9215 samples within 2 assays </span></span>
<span><span class="co">#&gt; Active assay: atac (70152 features, 0 variable features)</span></span>
<span><span class="co">#&gt;  3 layers present: counts, data, scale.data</span></span>
<span><span class="co">#&gt;  1 other assay present: rna</span></span>
<span><span class="co">#&gt;  1 dimensional reduction calculated: Spatial</span></span></code></pre></div>
<p>The data is now ready for an initial round of topic modeling aimed at
filtering and identifying technical noise and overrepresented features.
If working with a large dataset, consider selecting a representative
subset of cells to reduce runtime. For smaller datasets, such as the one
used here, which contains 9,215 spatial spots, the filtering model can
be trained on the full dataset.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtm_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MTM.html">MTM</a></span><span class="op">(</span><span class="va">p22</span>, n_topics <span class="op">=</span> <span class="fl">10</span>, n_jobs <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">mtm_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/VI.html">VI</a></span><span class="op">(</span><span class="va">mtm_model</span>, n_iter <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<p>After training the filtering-oriented model, the next step is to
identify features that are overrepresented across topics. These features
often have the highest cumulative activity across all topics and may
contribute more to technical noise than to meaningful biological
insights.</p>
<p>We apply a knee detection algorithm to filter them, which identifies
a sharp drop in cumulative feature activity and defines a cutoff point
for filtering. The sensitivity of this detection is controlled by the
<code>knee_sensitivity</code> parameter (<code>S</code>), which
determines how pronounced the drop must be to qualify as a knee. Lower
values of <code>S</code> result in more aggressive filtering, while
higher values yield more conservative thresholds.</p>
<p>For example, below is a knee plot for the RNA modality, showing the
distribution of feature activity and the detected cutoff.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_filter_var_knee.html">plot_filter_var_knee</a></span><span class="op">(</span><span class="va">mtm_model</span>, mod <span class="op">=</span> <span class="st">'rna'</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial1_plot1.png" width="100%"></p>
<p>In datasets with many features, the knee point may be challenging to
detect due to the dense distribution of activity values. To improve
visibility, you can limit the plot to the top-scoring features by
adjusting the <code>show_frac</code> parameter.</p>
<p>The <code>show_frac</code> parameter controls the fraction of
features to display, focusing on those with the highest cumulative
activity across topics. Reducing this fraction can make the knee point
more apparent, simplifying the selection of features to filter for a
cleaner and more interpretable analysis.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_filter_var_knee.html">plot_filter_var_knee</a></span><span class="op">(</span><span class="va">mtm_model</span>, mod <span class="op">=</span> <span class="st">'rna'</span>, show_frac <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial1_plot2.png" width="100%"></p>
<p>Once the appropriate <code>knee_sensitivity</code> values have been
selected for each modality, you can filter out the overrepresented
features using the <code>filter_var_knee</code> function. This step
refines the dataset by removing features that contribute primarily to
noise.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p22_filtered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_var_knee.html">filter_var_knee</a></span><span class="op">(</span><span class="va">p22</span>, model <span class="op">=</span> <span class="va">mtm_model</span>, knee_sensitivity <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">p22_filtered</span></span>
<span><span class="co">#&gt; An object of class Seurat </span></span>
<span><span class="co">#&gt; 87606 features across 9215 samples within 2 assays </span></span>
<span><span class="co">#&gt; Active assay: atac (64925 features, 0 variable features)</span></span>
<span><span class="co">#&gt;  3 layers present: data, scale.data, counts</span></span>
<span><span class="co">#&gt;  1 other assay present: rna</span></span>
<span><span class="co">#&gt;  1 dimensional reduction calculated: Spatial</span></span></code></pre></div>
<p>Alternatively, if you have a predefined list of features to retain,
you can use the <code>filter_var_list</code> function. This method
allows precise control over which features are preserved in the
dataset.</p>
<p>If RNA is one of the data modalities, we recommend further refining
the feature set by selecting highly variable genes (HVGs). HVGs exhibit
the most significant variability across cells and often carry the most
biologically relevant signal.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p22_rna</span> <span class="op">&lt;-</span> <span class="va">p22_filtered</span><span class="op">[[</span><span class="st">'rna'</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">p22_rna</span> <span class="op">&lt;-</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="va">p22_rna</span>, nfeatures <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Finding variable features for layer counts</span></span>
<span></span>
<span><span class="va">p22_atac</span> <span class="op">&lt;-</span> <span class="va">p22_filtered</span><span class="op">[[</span><span class="st">'atac'</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">p22_atac</span> <span class="op">&lt;-</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="va">p22_atac</span>, nfeatures <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Finding variable features for layer counts</span></span>
<span></span>
<span><span class="va">selected_genes</span> <span class="op">&lt;-</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/VariableFeatures.html" class="external-link">VariableFeatures</a></span><span class="op">(</span><span class="va">p22_rna</span><span class="op">)</span></span>
<span><span class="va">selected_peaks</span> <span class="op">&lt;-</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/VariableFeatures.html" class="external-link">VariableFeatures</a></span><span class="op">(</span><span class="va">p22_atac</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p22_filtered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_var_list.html">filter_var_list</a></span><span class="op">(</span><span class="va">p22</span>, var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">selected_genes</span>, <span class="va">selected_peaks</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Make sure to save the processed object after filtering to be used for
downstream topic model training.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#saveRDS(p22_filtered, file = paste0(working_dir, 'P22_Mouse_Brain_ATAC_RNA_filtered.rds'))</span></span></code></pre></div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Damian Panas, Piotr Rutkowski.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
